# LLM-Aware Gateway

> 语义感知的熔断/限流网关

## 📋 项目概述

LLM-Aware Gateway是一个基于语义分析的智能网关系统，通过向量化和聚类技术识别同类错误，实现精确熔断和限流，避免传统粗粒度策略的误杀问题。

### 🎯 核心价值

- **精确熔断**：基于错误语义聚类，仅对同类异常进行限流，避免误杀正常流量
- **快速响应**：同源异常数秒内生效，无需等待整体错误率升高
- **自动恢复**：故障退潮后自行逐步恢复流量
- **可观测性**：提供异常簇监控、链路分析能力

## 🏗️ 系统架构

```
[客户端]
   │
   ▼
[网关 (数据面)]
  ├─ 路由/鉴权 (JWT/OIDC)
  ├─ 指标/追踪 (OpenTelemetry)
  ├─ 令牌桶限流 (可热更新权重)
  ├─ 熔断器 (按路由/下游/异常簇)
  ├─ 错误采样器 (采样脱敏)
  └─ 异常向量化Agent
           │
           ▼
[控制面]
  ├─ 嵌入服务 (文本→向量)
  ├─ 向量库 (FAISS/pgvector)
  ├─ 在线聚类器 (相似度阈值/DBSCAN)
  ├─ 策略引擎 (异常簇策略生成)
  └─ 配置下发 (ETCD/Consul)
```

## 🚀 核心功能

### 1. 数据采集模块

- **采集内容**
  - 请求路径、方法、下游服务名
  - 响应状态码、错误文本/堆栈信息
  - 时间戳与traceId/spanId

- **数据处理**
  - 敏感信息脱敏 (手机号、邮箱、Token)
  - 可配置采样率 (默认5%)
  - 异步队列传输 (Kafka/Pulsar)

### 2. 向量化与聚类

- **文本向量化**
  - 错误文本模板化处理
  - 嵌入模型生成向量 (BGE/SimCSE)
  - 变量归一化处理

- **智能聚类**
  - 余弦相似度计算 (≥0.82归类现有簇)
  - 动态簇创建与中心记录
  - 定期簇重分配优化 (K-Means/HDBSCAN)

### 3. 策略引擎

- **触发条件**
  - 时间窗口内簇错误比例 ≥ 阈值 (默认20%)
  - 错误增长速率 ≥ 阈值 (如50次/10s)

- **策略类型**
  - **限流**：按簇严重度动态调整限流比例 (0.2-1.0)
  - **熔断**：对涉及路由/服务直接阻断
  - **降级**：返回预设响应或fallback逻辑

- **恢复机制**
  - 半开状态：逐步恢复流量 (每10s增加20%)
  - 异常检测：重现时重新触发保护

### 4. 策略执行 (数据面)

- 接收控制面策略配置
- 基于簇ID精确匹配请求
- 令牌桶/漏桶动态限流实现
- 熔断器状态管理与执行

### 5. 可观测性

- **监控指标**
  - 各簇规模、错误比例、热度趋势
  - 限流/熔断策略生效状态
  - 性能指标 (延迟、吞吐量)

- **链路追踪**
  - APM/Trace系统对接
  - 异常链路回溯分析

- **可视化界面**
  - 实时异常簇列表
  - 历史趋势曲线
  - 策略执行日志

## 🔧 关键算法

### 文本向量化
```
错误消息 + 堆栈前两帧 + 服务名 + HTTP方法 → 向量化
选择：Sentence Transformers / 轻量模型 (延迟<5ms/条)
```

### 相似度计算
```
余弦相似度：sim(u,v) = u·v / (||u||·||v||)
索引加速：HNSW/IVF 近邻检索
```

### 在线聚类
```
新向量与已有中心比较：
- sim ≥ τ (0.82) → 归入现有簇
- 否则 → 创建新簇
离线补偿：微批DBSCAN/HDBSCAN细化
```

### 熔断触发
```
簇C在窗口W内：
- 错误率：err_rate(C,W) ≥ α (20%)
- 增长率：d|C|/dt ≥ β (50条/10s)
触发条件：两者同时满足
```

### 动态限流
```
令牌速率 = 基础令牌 × (1 - r(C))
r(C)：簇严重度 (0-0.8)
```

## 📊 验收指标

| 指标 | 目标值 |
|------|--------|
| 减灾效果 | 同源故障5xx峰值下降 ≥ 40% |
| 性能开销 | P95延迟增加 ≤ 2ms |
| 误杀率 | 被限流但实际成功 ≤ 2% |
| 恢复速度 | 故障消除60s内恢复 |

## 🛣️ 交付计划

### 第1周 (MVP)
- [x] 网关采样与脱敏
- [x] 文本向量化服务
- [x] 基础聚类功能
- [x] 策略下发机制

### 第2周 (工程化)
- [ ] 簇级熔断与半开恢复
- [ ] 向量索引优化
- [ ] 监控系统接入
- [ ] 故障注入测试

### 第3周 (增强)
- [ ] A/B测试框架
- [ ] 跨实例簇状态共享
- [ ] 噪声过滤增强
- [ ] 性能调优

## ⚡ 快速开始

```bash
# 1. 克隆项目
git clone https://github.com/your-org/llm-aware-gateway.git

# 2. 启动控制面
cd control-plane
docker-compose up -d

# 3. 启动数据面
cd data-plane
./gateway --config config.yaml

# 4. 配置监控
kubectl apply -f monitoring/
```

## 📈 性能优化

- **向量缓存**：热门簇LRU缓存 (TTL 5min)
- **批量计算**：向量微批处理 (50条/批)
- **索引结构**：FAISS/Milvus加速查询
- **高可用**：控制面多副本 + 策略版本管理

## 🛡️ 风险控制

| 风险 | 应对策略 |
|------|----------|
| 向量化延迟 | 批处理 + 缓存优化 |
| 异常信息噪声 | 文本模板化去变量 |
| 限流过度 | 最小放行比例保护 |
| 聚类漂移 | 周期性重聚类 |

## 🤝 贡献指南

1. Fork 项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 📄 许可证

本项目采用 [MIT License](LICENSE) 许可证。

## 📞 联系方式

- 项目负责人: [你的邮箱]
- 技术讨论: [团队群组]
- 问题反馈: [GitHub Issues](../../issues)
